<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.84.1"><title>ROS Development with LXD | Ted Kern</title><link rel=canonical href=https://arnatious.com/blog/lxc/><link rel=stylesheet href=/css/normalize.css crossorigin=anonymous><link rel=stylesheet href=/css/main.css crossorigin=anonymous><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#ff0000><meta name=apple-mobile-web-app-title content="Arnatious"><meta name=application-name content="Arnatious"><meta name=msapplication-TileColor content="#b91d47"><meta name=theme-color content="#ff0000"><link rel=stylesheet href=/css/single.css crossorigin=anonymous></head><body><nav><ul><li class=nav-item><a href=/ title>Home</a></li><li class=nav-item><a href=/about/ title>About</a></li><li class=nav-item><a href=/blog/ title>Blog</a></li><li class=nav-item><a href=/contact/ title>Contact</a></li></ul></nav><input type=checkbox id=nav-trigger class="nav-trigger visuallyhidden">
<label for=nav-trigger></label><div class=container><header><h1>Ted Kern</h1></header><main><section id=main><h1 id=title>ROS Development with LXD</h1><article id=content><p>Linux containers allow for easy isolation of developer environments. If you&rsquo;re often working with a bunch of different ROS versions, it&rsquo;s a lot easier to do your work entirely in containers.</p><h2 id=getting-started>Getting Started</h2><p>You&rsquo;ll first need to install LXD using snap.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ sudo snap install lxd
lxd 3.21 from Canonical✓ installed
</code></pre></div><blockquote><h2 id=note>Note</h2><p>Throughout this guide I will be using the hostname to distinguish which machine I&rsquo;m running commands on.</p><p><code>lxhost</code> represents the bare metal machine you&rsquo;ll be creating containers in.</p><p><code>ros1-live</code> is the container we&rsquo;ll be creating later</p><p><code>remote-pc</code> is a different machine on the same LAN as lxhost</p><p>Pay attention to the value after the <code>@</code> in the shell prompts to make sure you run commands on the right machine.</p></blockquote><p>If you haven&rsquo;t added <code>/snap/bin</code> to your PATH yet, you&rsquo;ll want to in order to call the programs snap installs.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ export PATH<span style=color:#f92672>=</span>/snap/bin:$PATH
</code></pre></div><p>You&rsquo;ll need to initialize LXD before your first run. I&rsquo;ll be using default settings for this example, but you should look into the settings to make sure of what you&rsquo;re getting into. The exact printout may vary depending on your system, as well as what version of LXD you&rsquo;re using</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ lxd init
Would you like to use LXD clustering? <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>no<span style=color:#f92672>]</span>:
Do you want to configure a new storage pool? <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>yes<span style=color:#f92672>]</span>:
Name of the new storage pool <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>default<span style=color:#f92672>]</span>:
Would you like to connect to a MAAS server? <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>no<span style=color:#f92672>]</span>:
Would you like to create a new local network bridge? <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>yes<span style=color:#f92672>]</span>:
What should the new bridge be called? <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>lxdbr0<span style=color:#f92672>]</span>:
What IPv4 address should be used? <span style=color:#f92672>(</span>CIDR subnet notation, “auto” or “none”<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>auto<span style=color:#f92672>]</span>:
What IPv6 address should be used? <span style=color:#f92672>(</span>CIDR subnet notation, “auto” or “none”<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>auto<span style=color:#f92672>]</span>:
Would you like LXD to be available over the network? <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>no<span style=color:#f92672>]</span>:
Would you like stale cached images to be updated automatically? <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>yes<span style=color:#f92672>]</span>
Would you like a YAML <span style=color:#e6db74>&#34;lxd init&#34;</span> preseed to be printed? <span style=color:#f92672>(</span>yes/no<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>default<span style=color:#f92672>=</span>no<span style=color:#f92672>]</span>:
ubuntu@lxhost:~$
</code></pre></div><p>This handled setting a number of configuration options for us, as well as creating a storage pool for any containers we make and a network bridge (named <code>lxdbr0</code> above) that will connect our containers to the network.</p><blockquote><h3 id=heads-up>Heads Up</h3><p>LXD runs as a daemon on your system that is accessible to <code>root</code> and the <code>lxd</code> group on your system. Users with access to LXD can attach host devices and filesystems, presenting a security risk. Only add users you&rsquo;d trust with root access to lxd.</p><p>You can read more about LXD security in its <a href=https://linuxcontainers.org/lxd/docs/master/security>documentation</a>.</p></blockquote><h2 id=the-lxc-command>The LXC command</h2><p>LXD provides an <code>lxc</code> program you&rsquo;ll use to actually manage the containers. You <em>can</em> invoke this with <code>lxd.lxc</code>, but lxc works just fine. Make sure your PATH resolves to the correct lxc.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ which lxc
/snap/bin/lxc
</code></pre></div><p>If you installed lxc via <code>apt</code> before, and your <code>/usr/bin</code> directory comes before <code>/snap/bin</code> in PATH, you&rsquo;ll run the wrong lxc command. You probably should go ahead and uninstall that lxc.</p><p>LXC provides a number of verbs:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>ubuntu@lxhost:~$ lxc
alias      copy       file       info       manpage    operation  publish    restart    start
cluster    delete     help       init       monitor    pause      query      restore    stop
config     exec       image      launch     move       profile    remote     shell      storage
console    export     import     list       network    project    rename     snapshot   version
</code></pre></div><p>(Output from tab completion)</p><p>We&rsquo;ll go through some of these, but you can always use <code>lxc &lt;verb> --help</code> to get more details (or <code>man lxc.&lt;verb></code>, but those are currently just autogenerated from the help text).</p><h2 id=creating-a-container>Creating a container</h2><p>We&rsquo;ll start with a ROS Melodic container. I&rsquo;m currently running Ubuntu 20.04 Focal preview, so this is actually the easiest way in my case to work with an older ROS.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ lxc launch ubuntu:18.04 ros1-live
Creating ros1-live
Starting ros1-live
...

</code></pre></div><p>Just like that, we&rsquo;ve spun up a container. An Ubuntu 18.04 machine named ros1-live is now available. <code>lxc list</code> will show it.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ lxc list
+---------------+---------+-----------------------+-----------------+-----------+-----------+
|     NAME      |  STATE  |         IPV4          |      IPV6       |   TYPE    | SNAPSHOTS |
+---------------+---------+-----------------------+-----------------+-----------+-----------+
| ros1-live     | RUNNING | 10.141.221.65 <span style=color:#f92672>(</span>eth0<span style=color:#f92672>)</span>  |                 | CONTAINER | <span style=color:#ae81ff>0</span>         |
+---------------+---------+-----------------------+-----------------+-----------+-----------+
</code></pre></div><p>To work in it, we&rsquo;ll use <code>lxc exec</code> to run a login shell as the default ubuntu user:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ lxc exec ros1-live -- sudo -iu ubuntu bash
ubuntu@ros1-live:~$
</code></pre></div><h2 id=ssh-access>SSH Access</h2><p>Depending on how we like to develop, we may prefer to ssh in (for instance, to use vscode&rsquo;s remote tools). We&rsquo;ll need to add our keys to the container to do so.</p><p>If our public key is stored at <code>~/.ssh/id_rsa.pub</code>, we can add it in a number of ways.</p><p>Here we&rsquo;ll simply create an authorized_keys file with our public key in it, and push it</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ cp ~/.ssh/id_rsa.pub /tmp/authorized_keys
ubuntu@lxhost:~$ lxc file push /tmp/authorized_keys ros1-live/home/ubuntu/.ssh/authorized_keys -p
</code></pre></div><p>The <code>-p</code> argument creates parents, as per <code>mkdir -p</code>.</p><p>We can now ssh into our container from the host and other containers. You can get the ip address using <code>lxc list</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ lxc list
+---------------+---------+-----------------------+-----------------+-----------+-----------+
|     NAME      |  STATE  |         IPV4          |      IPV6       |   TYPE    | SNAPSHOTS |
+---------------+---------+-----------------------+-----------------+-----------+-----------+
| ros1-live     | RUNNING | 10.141.221.65 <span style=color:#f92672>(</span>eth0<span style=color:#f92672>)</span>  |                 | CONTAINER | <span style=color:#ae81ff>0</span>         |
+---------------+---------+-----------------------+-----------------+-----------+-----------+
ubuntu@lxhost:~$ ssh ubuntu@10.141.221.65
ubuntu@ros1-live:~$
</code></pre></div><p>You may want to add this address to your <code>.ssh/config</code> file</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>Host ros1-live
    HostName 10.141.221.65
    User ubuntu
    IdentityFile ~/.ssh/id_rsa
    ForwardAgent Yes
    ForwardX11 Yes
</code></pre></div><h3 id=remote-access>Remote Access</h3><p>If you&rsquo;d like to access the container from a remote pc, the default bridged network setup makes things tricky, as the containers are behind a NAT on the host. The easiest way to ssh in is to use the host as a jumphost.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@remote-pc:~$ ssh -J &lt;host-address&gt; ros1-live
</code></pre></div><p>or in the config file</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@remote-pc:~$ cat ~/.ssh/config
Host ros1-live
    HostName 10.141.221.65
    User ubuntu
    ProxyJump &lt;host-address&gt;
    IdentityFile ~/.ssh/id_rsa
    ForwardAgent Yes
    ForwardX11 Yes
ubuntu@remote-pc:~$ ssh ros1-live
ubuntu@ros1-live:~$
</code></pre></div><p>If your remote PC is running Windows, you&rsquo;re likely using a version of ssh without the ProxyJump command. I recommend downloading the <a href=https://github.com/PowerShell/openssh-portable/releases>latest release of OpenSSH</a> and putting it at the front of your Windows PATH variable, so VSCode and other tools can use it.</p><p>If you need more direct access, you can add an lxc proxy device to the container to forward a port into it</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ lxc config device add rosl-live proxy22 proxy connect<span style=color:#f92672>=</span>tcp:127.0.0.1:22 listen<span style=color:#f92672>=</span>tcp:0.0.0.0:2222
ubuntu@lxhost:~$ lxc config device show ros1-live
proxy22:
  connect: tcp:127.0.0.1:22
  listen: tcp:0.0.0.0:2222
  type: proxy
</code></pre></div><p>This will listen on the host port 2222 and forward connections to the container&rsquo;s port 22. You can learn more about proxy devices <a href=https://linuxcontainers.org/lxd/docs/master/instances#type-proxy>here</a>.</p><p>If you don&rsquo;t want the container behind a NAT on the host, you can specify a different bridge configuration or add an IPVLAN or MACVLAN <code>nic</code> network device to the container. You can read more about <code>nic</code> devices <a href=https://linuxcontainers.org/lxd/docs/master/instances#type-nic>here</a>.</p><h2 id=sharing-files-transparently>Sharing Files Transparently</h2><p>You can neatly share directories between the host and the container using <code>disk</code> devices. Disk devices can be a bind-mount of an existing file or directory, a regular mount of a block device, or one of several other source types. You can read about <code>disk</code> devices <a href=https://linuxcontainers.org/lxd/docs/master/instances#type-nic>here</a>.</p><p>Lets create a directory and share it with the container:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ mkdir share <span style=color:#f92672>&amp;&amp;</span> cd share
ubuntu@lxhost:~/share$ mkdir ros1-live
ubuntu@lxhost:~/share$ lxc config device add ros1-live share disk source<span style=color:#f92672>=</span>~/share/ros1-live path<span style=color:#f92672>=</span>/home/ubuntu/share
</code></pre></div><p>In order to truly share access, we&rsquo;ll want to use the <code>raw.idmap</code> config option for the container to map your UID and GID. Assuming your UID and GID on the host is 1000 (the default for a single user Ubuntu installation), you&rsquo;ll use the following command to set the option:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ lxc config set ros1-live raw.idmap <span style=color:#e6db74>&#34;both 1000 1000&#34;</span>
</code></pre></div><p>Now any files you make and modify in the host and the container will be indistinguishable, permission-wise.</p><p>To verify the directory is shared:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ ssh ros1-live
ubuntu@ros1-live:~$ ls
share
</code></pre></div><h2 id=set-up-ros>Set up ROS</h2><p>For once, setting up ROS will be the easy part. Just follow the instructions at the <a href=http://wiki.ros.org/melodic/Installation/Ubuntu>ROS wiki</a> like normal.</p><h2 id=developing-in-the-container>Developing in the Container</h2><p>Create a <code>workspace</code> directory in the share directory, and use it as normal to develop.</p><h3 id=devices>Devices</h3><p>If you intend to interface with actual hardware, you&rsquo;ll need to attach devices to your container. I&rsquo;ve linked to the <code>device</code> configuration option several times before, but you&rsquo;ll want to look at it in depth for configuring your hardware.</p><p>For example, if you&rsquo;re controlling an OpenManipulatorX via a U2D2, you&rsquo;ll need to communicate via serial. This is done via a Unix character device at <code>/dev/ttyUSB0</code> or similar. To add it to the container as a <a href=https://linuxcontainers.org/lxd/docs/master/instances#type-unix-char>unix-char device</a>, use</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ lxc config device add ros1-live ttyusb0 unix-char source<span style=color:#f92672>=</span>/dev/ttyUSB0 path<span style=color:#f92672>=</span>/dev/ttyUSB0
</code></pre></div><p>You can also forward the entire usb device using the vendorid and productid of the device as you would for a udev rule. See the entry on <a href=https://linuxcontainers.org/lxd/docs/master/instances#type-usb>usb devices</a>.</p><h3 id=guis>GUIs</h3><p>You may notice GUI programs don&rsquo;t work, either well or at all, in containers. Simos Xenitellis wrote a <a href=https://blog.simos.info/how-to-easily-run-graphics-accelerated-gui-apps-in-lxd-containers-on-your-ubuntu-desktop/>wonderful guide</a> on how to fix this and you&rsquo;ll be able to run Gazebo, RViz, et al in your containers.</p><p>Create a new <code>profile</code> for your containers as follows: (<strong>Note</strong>: this will use vim, if you do not know vim, use the alternative further below):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ lxc profile create gui
ubuntu@lxhost:~$ lxc profile edit gui
</code></pre></div><p>and add the following to the config file that opened in vim</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>config</span>:
  <span style=color:#f92672>environment.DISPLAY</span>: :<span style=color:#ae81ff>0</span>
  <span style=color:#f92672>raw.idmap</span>: <span style=color:#ae81ff>both 1000 1000</span>
  <span style=color:#f92672>user.user-data</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>    #cloud-config
</span><span style=color:#e6db74>    runcmd:
</span><span style=color:#e6db74>      - &#39;sed -i &#34;s/; enable-shm = yes/enable-shm = no/g&#34; /etc/pulse/client.conf&#39;
</span><span style=color:#e6db74>      - &#39;echo export PULSE_SERVER=unix:/tmp/.pulse-native | tee --append /home/ubuntu/.profile&#39;
</span><span style=color:#e6db74>    packages:
</span><span style=color:#e6db74>      - x11-apps
</span><span style=color:#e6db74>      - mesa-utils
</span><span style=color:#e6db74>      - pulseaudio</span>    
<span style=color:#f92672>description</span>: <span style=color:#ae81ff>GUI LXD profile</span>
<span style=color:#f92672>devices</span>:
  <span style=color:#f92672>PASocket</span>:
    <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/tmp/.pulse-native</span>
    <span style=color:#f92672>source</span>: <span style=color:#ae81ff>/run/user/1000/pulse/native</span>
    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>disk</span>
  <span style=color:#f92672>X0</span>:
    <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/tmp/.X11-unix/X0</span>
    <span style=color:#f92672>source</span>: <span style=color:#ae81ff>/tmp/.X11-unix/X0</span>
    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>disk</span>
  <span style=color:#f92672>mygpu</span>:
    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>gpu</span>
<span style=color:#f92672>name</span>: <span style=color:#ae81ff>gui</span>
<span style=color:#f92672>used_by</span>:
</code></pre></div><blockquote><p>Alternatively, if you do not know or like touching vim, save the above to a temporary file, say, <code>/tmp/foo.yaml</code>, and do the following instead:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ lxc profile create gui
ubuntu@lxhost:~$ lxc profile edit gui &lt; /tmp/foo.yaml
</code></pre></div></blockquote><p>(see documentation on profiles <a href=https://linuxcontainers.org/lxd/docs/master/profiles>here</a>).</p><p>To summarize the above, we tell lxc that every device with a <code>gui</code> profile on it should</p><ul><li>Do the <code>raw.idmap</code> config from earlier.</li><li>Set <code>DISPLAY=:0</code></li><li>On cloud-init, disable shm in <code>/etc/pulse/client.conf</code></li><li>Set the pulse audio server to a socket <code>/tmp/.pulse_native</code></li><li>Install <code>x11-apps</code>, <code>mesa-utils</code>, and <code>pulseaudio</code></li><li>Mount the pulseaudio socket from the host to to <code>/tmp/.pulse_native</code></li><li>Mount the X11 socket</li><li>Mount your gpu</li></ul><p>We apply this profile to the existing container using:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ lxc profile add ros1-live gui
</code></pre></div><p>Which adds the <code>gui</code> profile alongside the already applied <code>default</code> profile to the container.</p><p>Restart the container using:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ubuntu@lxhost:~$ lxc restart ros1-live
</code></pre></div><p>And after ~30 seconds of downloading and installing the packages, the container should be up and ready to use. You can get GUI apps over ssh with X11 forwarding, or just from the <code>lxc exec</code> method of getting a shell.</p></article></section></main><footer><p>&copy; 2021 Ted Kern. Made with
<a href=https://gohugo.io>Hugo</a> and
<a href=https://html5boilerplate.com/>HTML5 Boilerplate</a></p><p><svg width="50" height="50"><a href="https://www.gitlab.com/arnatious"><image href="/img/stacked_wm_no_bg.svg" height="50" width="50"/></a></svg>&ensp;<svg width="50" height="50"><a href="https://www.github.com/arnatious"><image href="/img/GitHub-Mark.svg" height="50" width="50"/></a></svg></p></footer></div></body></html>